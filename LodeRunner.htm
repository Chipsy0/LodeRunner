<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Lode Runner par Caroline Chagnon et Razvan Pruteanu</title>
    <link rel="stylesheet" type="text/css" href="StyleProjet1.css" />
    <!-- Code JavaScript local -->
    <script type="text/javascript" src="cordes.js"></script>
    <script type="text/javascript" src="creerSons.js"></script>
    <script type="text/javascript" src="echelles.js"></script>
    <script type="text/javascript" src="lingots.js"></script>
    <script type="text/javascript" src="murs.js"></script>
    <script type="text/javascript" src="panneau.js"></script>
    <script type="text/javascript" src="passerelles.js"></script>
    <script type="text/javascript" src="runner.js"></script>
    <script type="text/javascript" src="sol.js"></script>
    <script type="text/javascript" src="tableaux.js"></script>
    <script type="text/javascript" src="texte.js"></script>
    <script type="text/javascript" src="trou.js"></script>
    <script type="text/javascript">
        var objCanvas = null;
        var objC2D = null;
        var objCycleAnimation = null;
        var objRunner = null;
        var tabTableau = null;
        var tabObjets = null;
        var binEnMouvementX = false;
        var binMouvementDOWN = false;
        var binMouvementUP = false;
        var binFall = false;
        var binMouvementLeft = false;
        var binMouvementRight = false;
        var intScore = 0;
        var objDateDebut = null;
        var binCommence = false;
        var intMillisecondesTot = 0;
        var intSecondes = 0;
        var intMinutes = 0;
        var intNiveau = 1;
        var intNbVies = 5;
        var fltAnim = 0;
        var binInverseAnim = false;
        var intPinxel = 0;
        var binDansEchelle = false;
        var binSurCorde = false;
        var intnbLingot = 0;
        var binTrouLeft = false;
        var binTrouRight = false;    
        var objSons = null; 
        var binMort = false;
        var intScoreNiveau = 0;

        function initAnimation() {
            objCanvas = document.getElementById('monCanvas');
            objCanvas.focus();
            objC2D = objCanvas.getContext('2d');
            tabObjets = new Array(22);
            for (var i = 0; i < tabObjets.length; i++) {
                tabObjets[i] = new Array(30);
            }
            initSons();
            initRunner();
            initTableau();
            dessiner(); // Dessiner une première fois
            animer();  // animer
        }

        // Un cycle d'animation	
        function animer() {
            // Requête pour le prochain cycle
            objCycleAnimation = requestAnimationFrame(animer);

            // Le cycle d'animation
            effacerDessin();
            mettreAjourAnimation();
            dessiner();
        }

        // Arrêter l'animation
        function arreterAnimation() {
            if (objCycleAnimation != null)
                cancelAnimationFrame(objCycleAnimation);
            objCycleAnimation = null;
        }

        // Pour effacer le dessin
        function effacerDessin() {
            objC2D.clearRect(0, 0, objCanvas.width, objCanvas.height);
        }

        // Pour mettre à jour l'animation
        function mettreAjourAnimation() {

            if (binCommence == true) {
                updateChrono();
            }

            if (intnbLingot == 6) {
                apparitionEchelleDeFin();
            }

            //mouvement 
            if (binFall == false && binMort == false) {

                //check if won
                if (Math.floor(objRunner.intY / 30) == 0 && Math.floor(objRunner.intX / 30) == 19) {
                    intScore += 1500;
                    intNiveau++;
                    tabTableau[1][19] = 0;
                    tabTableau[2][19] = 0;
                    tabTableau[3][19] = 0;
                    tabTableau[4][19] = 0;

                    tabObjets[1][19] = null;
                    tabObjets[2][19] = null;
                    tabObjets[3][19] = null;
                    tabObjets[4][19] = null;

                    initRunner();
                    initTableau();
                    intnbLingot = 0;
                    binCommence = false;
                    intScoreNiveau = 0;
                    debutChrono();
                }

                //check if dead
                if (tabTableau[Math.floor(objRunner.intY / 30 )][Math.floor(objRunner.intX / 30)] == 1
                    && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 1) {
                    objSons.dead.play();
                    binMort = true;

                }

                //collecter lingot 
                if ((tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 3
                    || tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 3)) {
                        collecterLingot(Math.floor(objRunner.intY / 30),Math.floor(objRunner.intX / 30));
                }
                //check si il y a un trou pour tomber
                if (((tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] == 0
                    && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 0)
                    && (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 0
                        && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 0))
                    || (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] == 5
                        && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 5)
                    || (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] == 8
                        && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 8)) {
                    binFall = true;
                }
                binSurCorde = false;
                //verify pour allez correctement sur corde
                if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 5
                    && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 5) {
                    var locY = Math.floor(objRunner.intY / 30);
                    // vérifie pour animation si le bloc en dessous est une passerelle ou une échelle
                    if (tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30)] != 1
                        && tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 1
                        && tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30)] != 2
                        && tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 2) {
                        binSurCorde = true;
                    }
                }
                if (binMouvementLeft == true || binMouvementRight == true) {
                    //verify pour allez correctement sur corde
                    if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 5
                        && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 5) {
                        var locY = Math.floor(objRunner.intY / 30);
                        if (Math.floor(objRunner.intY) != locY * 30 + 2) {
                            binFall = true;
                        }
                        // vérif pour animation si le bloc en dessous est une passerelle ou une échelle
                        if (tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30)] != 1
                            && tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 1
                            && tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30)] != 2
                            && tabTableau[Math.floor(objRunner.intY / 30) + 1][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 2) {
                            binSurCorde = true;
                        }
                    }

                }

                //mouvement gauche
                if (binMouvementLeft == true) {
                    if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] != 6
                        && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] != 1
                        && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab - 1 / 30)][Math.floor(objRunner.intX / 30)] != 1) {
                        objRunner.intX += objRunner.intDirectionX * objRunner.intVitesse;
                    }
                }
                //mouvement droit
                if (binMouvementRight == true) {
                    if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 6
                        && (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 1
                            && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab - 1 / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 1)) {

                        objRunner.intX += objRunner.intDirectionX * objRunner.intVitesse;
                    }
                }

                //mouvement bas et haut
                binDansEchelle = false;
                if (binMouvementUP == true || binMouvementDOWN == true) {
                    //check s'il est dans l'echelle
                    if ((tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 2
                        && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 2)
                        || (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] == 2
                            && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 2)) {

                        binDansEchelle = true

                        //mouvement en haut
                        if (binMouvementUP == true) {
                            if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + (objRunner.intLargeur / 2) / 30)] == 2
                                || tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab - 1 / 30)][Math.floor(objRunner.intX / 30 + (objRunner.intLargeur / 2) / 30)] == 2) {
                                objRunner.intY -= objRunner.intDirectionY * objRunner.intVitesse;
                            }

                        } else {
                            //mouvement en bas
                            if ((tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab + 3 / 30)][Math.floor(objRunner.intX / 30 + (objRunner.intLargeur / 2) / 30)] != 2
                                && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + (objRunner.intLargeur / 2) / 30)] == 2)
                                || tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab + 3 / 30)][Math.floor(objRunner.intX / 30 + (objRunner.intLargeur / 2) / 30)] == 2) {

                                objRunner.intY += objRunner.intDirectionY * objRunner.intVitesse;
                            }
                        }
                    }
                    //mouvement en bas check s'il y a un trou
                    if (binMouvementUP == false) {
                        if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 5
                            && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 5
                            && (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] == 0
                                && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 0)) {
                            binFall = true;
                        }
                    }
                }               
            }
             //tomber
            if (binFall == true) {
                objSons.falling.play();
                objRunner.intY += 1 * objRunner.intVitesse;

                if ((tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] != 0
                    && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 0)
                    && (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] != 3
                        && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 3)
                    && (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] != 5
                        && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 5)
                    && (tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30)] != 8
                        && tabTableau[Math.floor(objRunner.intY / 30 + objRunner.intHauteurTab)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] != 8)) {
                    binFall = false;
                    objSons.falling.pause();
                    objSons.currentTime = 0;
                }

                if (tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30)] == 5
                    && tabTableau[Math.floor(objRunner.intY / 30)][Math.floor(objRunner.intX / 30 + objRunner.intLargeurTab)] == 5) {
                    var locY = Math.floor(objRunner.intY / 30);
                    if (Math.floor(objRunner.intY) == locY * 30 + 2) {
                        binFall = false;
                        objSons.falling.pause();
                        objSons.currentTime = 0;
                    }
                }
            }
            
            //si Lode runenr mort
            if (binMort == true) {
                objRunner.intY -= 1 * objRunner.intVitesse;
                if (Math.floor(objRunner.intY / 30) == 0){
                    intNbVies--;
                    binMort = false;
                    initRunner();
                    initTableau();
                    intnbLingot = 0;
                    binCommence = false;
                    debutChrono();
                    console.log(intScoreNiveau);
                    intScore -= intScoreNiveau;
                    intScoreNiveau = 0;

                }

            }
        }

    </script>
</head>

<body onload="initAnimation()">
    <canvas id="monCanvas" width="900" height="660" tabIndex="1" class="sCanvas" onkeydown="deplacerRunner(); trou();"
        onkeyup='binMouvementLeft=false; binMouvementRight=false; binMouvementDOWN=false; binMouvementUP=false; binTrouRight=false; binTrouLeft=false;'>
        Votre navigateur ne supporte pas la balise canvas
    </canvas>
</body>

</html>